<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Integrova Login</title>
    <link rel="icon" href="../assets/logoinsightdorado.png" type="image/x-icon">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css" rel="stylesheet">
    <link rel="stylesheet" href="../css/styles.css">
</head>

<body>
    <div class="login-page">
        <div class="login-wrapper">
            <div class="logo-brand">
                <img src="../assets/logointegrovadorado.png" alt="Integrova" class="logo-brand-img">
            </div>

            <div class="login-container">
                <div id="alertContainer"></div>

                <form id="loginForm">
                    <div class="form-group">
                        <label for="email" class="form-label">Correo electr√≥nico</label>
                        <input type="email" class="form-control" id="email" placeholder="tu correo" required>
                    </div>
                    <div class="form-group">
                        <label for="password" class="form-label">Contrase√±a</label>
                        <div class="input-group">
                            <input type="password" class="form-control" id="password" placeholder="Tu contrase√±a"
                                required>
                            <button class="btn btn-toggle-password" type="button" id="togglePassword">
                                <i class="bi bi-eye"></i>
                            </button>
                        </div>
                    </div>
                    <button type="submit" class="btn btn-login">
                        <i class="bi bi-box-arrow-in-right"></i> Entrar
                    </button>
                </form>
            </div>
        </div>
    </div>

    <footer class="footer-login">
        <p>&copy; 2025 Integrova. Sistema Integral de Gesti√≥n y Auditor√≠a v2.0</p>
    </footer>

    <!-- ========================================
         SCRIPTS - ORDEN CR√çTICO
         ======================================== -->

    <!-- 1. SDK Supabase v2 PRIMERO (desde CDN) -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <!-- 2. Configuraci√≥n global (sin import.meta) -->
    <script src="../js/config.js"></script>

    <!-- 3. Configuraci√≥n Supabase (inyecta window.SUPABASE_CONFIG) -->
    <script src="../js/config-supabase.js"></script>

    <!-- 4. Cliente Supabase (crea window.supabaseClient) -->
    <script src="../js/supabaseClient.js"></script>

    <!-- 5. API Client centralizado (crea window.API) -->
    <script src="../js/api-client.js"></script>

    <!-- 6. Bootstrap JS (necesario para componentes) -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <!-- 7. Crypto JS para funciones auxiliares -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>

    <!-- 8. Utilidades globales -->
    <script src="../js/utils.js"></script>

    <!-- 9. L√≥gica de login (vanilla JS) -->
    <script>
        (function () {
            'use strict';

            console.log('üìù login.html: Inicializando formulario de login...');

            const form = document.getElementById('loginForm');
            const alertContainer = document.getElementById('alertContainer');
            const emailInput = document.getElementById('email');
            const passwordInput = document.getElementById('password');
            const submitBtn = form.querySelector('button[type="submit"]');

            const showAlert = (message, type = 'danger', timeout = 4000) => {
                alertContainer.innerHTML = `
                    <div class="alert alert-${type}" role="alert">
                        <i class="bi ${type === 'success' ? 'bi-check-circle' : 'bi-exclamation-triangle'}"></i> ${message}
                    </div>
                `;
                if (timeout) {
                    setTimeout(() => { alertContainer.innerHTML = ''; }, timeout);
                }
            };

            // Validar que Supabase est√° disponible
            async function initLogin() {
                console.log('üîÑ login.html: Esperando Supabase...');
                const supabaseClient = await window.getSupabaseClient();

                if (!supabaseClient) {
                    console.error('‚ùå login.html: Supabase no disponible');
                    showAlert('‚ö†Ô∏è Sistema no disponible. Contacta al administrador.', 'danger');
                    submitBtn.disabled = true;
                    return;
                }

                console.log('‚úÖ login.html: Supabase disponible');

                // Verificar si hay sesi√≥n activa
                // ‚úÖ CORRECCI√ìN: No redirigir si hay logout manual
                if (window.__MANUAL_LOGOUT__) {
                    console.log('üö´ Logout manual detectado - No redirigir autom√°ticamente');
                    return;
                }

                const { data: { session } } = await supabaseClient.auth.getSession();
                if (session?.user) {
                    console.log('‚úÖ login.html: Sesi√≥n activa detectada, redirigiendo...');
                    window.location.href = 'dashboard.html';
                    return;
                }

                // Setup form submit
                form.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    const email = emailInput.value.trim();
                    const password = passwordInput.value.trim();

                    if (!email || !email.includes('@')) {
                        showAlert('Ingresa un correo v√°lido.', 'danger');
                        return;
                    }

                    if (!password) {
                        showAlert('Ingresa tu contrase√±a.', 'danger');
                        return;
                    }

                    const originalText = submitBtn.innerHTML;
                    submitBtn.disabled = true;
                    submitBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Iniciando sesi√≥n...';

                    try {
                        const { data, error } = await supabaseClient.auth.signInWithPassword({ email, password });

                        if (error) {
                            throw error;
                        }

                        if (data?.session?.user) {
                            console.log('‚úÖ login.html: Login exitoso, redirigiendo...');

                            // üîì Limpiar flag de logout manual (permitir sesi√≥n)
                            window.__MANUAL_LOGOUT__ = false;
                            console.log('‚úÖ Flag __MANUAL_LOGOUT__ desactivado - Login permitido');

                            showAlert('¬°Bienvenido!', 'success', 1000);
                            setTimeout(() => {
                                window.location.href = 'dashboard.html';
                            }, 1000);
                        } else {
                            throw new Error('No se estableci√≥ sesi√≥n');
                        }
                    } catch (error) {
                        console.error('‚ùå login.html: Error en login:', error);
                        const message = error.message?.includes('Invalid login credentials')
                            ? 'Usuario o contrase√±a incorrectos.'
                            : error.message || 'Error al iniciar sesi√≥n.';
                        showAlert(message, 'danger');
                    } finally {
                        submitBtn.disabled = false;
                        submitBtn.innerHTML = originalText;
                    }
                });

                // Toggle password visibility
                document.getElementById('togglePassword')?.addEventListener('click', function () {
                    const icon = this.querySelector('i');
                    if (passwordInput.type === 'password') {
                        passwordInput.type = 'text';
                        icon.className = 'bi bi-eye-slash';
                    } else {
                        passwordInput.type = 'password';
                        icon.className = 'bi bi-eye';
                    }
                });
            }

            // Esperar DOMContentLoaded e iniciar
            if (document.readyState === 'loading') {
                document.addEventListener('DOMContentLoaded', initLogin);
            } else {
                initLogin();
            }
        })();
    </script>
</body>

</html>