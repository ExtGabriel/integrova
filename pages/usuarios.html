<!DOCTYPE html>
<html lang="es">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Integrova - Gesti√≥n de Usuarios</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css" rel="stylesheet">
  <link rel="stylesheet" href="../css/styles.css">
  <link rel="stylesheet" href="../css/usuarios.css">
</head>

<body>
  <header class="header-dashboard">
    <div class="header-left">
      <h1 class="page-title">Integrova - Usuarios</h1>
    </div>
    <div class="header-center">
      <div class="buscador">
        <i class="bi bi-search"></i>
        <input id="searchInput" type="text" placeholder="Buscar por usuario, nombre, correo o tel√©fono...">
      </div>
    </div>
    <div class="header-right">
      <select id="roleFilter" class="form-select filter-select">
        <option value="">Todos los roles</option>
        <option value="cliente">Cliente</option>
        <option value="auditor">Auditor</option>
        <option value="auditor_senior">Auditor Senior</option>
        <option value="supervisor">Supervisor</option>
        <option value="socio">Socio</option>
        <option value="administrador">Administrador</option>
        <option value="programador">Programador</option>
      </select>
      <button class="header-btn" id="addUserBtn" onclick="openAddModal()" title="Agregar Usuario">
        <i class="bi bi-person-plus"></i>
      </button>
      <button class="header-btn" onclick="window.location.href='dashboard.html'" title="Dashboard">
        <i class="bi bi-house"></i>
      </button>
      <button class="header-btn" id="logoutBtn" onclick="logout()" title="Salir">
        <i class="bi bi-box-arrow-right"></i>
      </button>
    </div>
  </header>

  <div class="main-container">
    <div class="usuarios-container">
      <div class="table-responsive">
        <table class="table table-striped table-hover" id="usersTable">
          <thead>
            <tr>
              <th>Usuario</th>
              <th>Nombre</th>
              <th>Correo</th>
              <th>Tel√©fono</th>
              <th>Rol</th>
              <th>Equipo</th>
              <th>Estado</th>
              <th>Contrase√±a</th>
              <th>Acciones</th>
            </tr>
          </thead>
          <tbody id="usersTableBody">
            <!-- Rows will be populated by JavaScript -->
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <div class="footer-full">
    <p>&copy; 2025 CFE INSIGHT. Sistema de Auditor√≠a v1.0. Todos los derechos reservados.</p>
  </div>

  <!-- ========================================
       SCRIPTS - ORDEN CR√çTICO PARA ESTABILIDAD
       ======================================== -->

  <!-- 1. SDK Supabase v2 PRIMERO -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <!-- 2. Configuraci√≥n global -->
  <script src="../js/config.js"></script>

  <!-- 3. Configuraci√≥n Supabase -->
  <script src="../js/config-supabase.js"></script>

  <!-- 4. Cliente Supabase -->
  <script src="../js/supabaseClient.js"></script>

  <!-- 5. Utilidades globales (UI stubs) -->
  <script src="../js/utils.js"></script>

  <!-- 6. API Client centralizado -->
  <script src="../js/api-client.js"></script>

  <!-- 7. Auth Guard -->
  <script src="../js/auth-guard.js"></script>

  <!-- 8. Script inline espec√≠fico de usuarios -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
  <script>
    let users = [];
    let visibleUsers = new Set();

    function normalizeToArray(value) {
      if (!value) return [];
      if (Array.isArray(value)) return value;
      if (typeof value === 'object') return [value];
      return [];
    }

    function appendCellContent(td, content) {
      if (!content && content !== 0) {
        td.textContent = '';
        return;
      }
      if (content instanceof Node) {
        td.appendChild(content);
      } else {
        td.innerHTML = String(content);
      }
    }

    async function loadUsers() {
      try {
        showLoading(true);
        const result = await API.Users.getAll();

        if (!result.success || !result.data) {
          users = [];
          console.warn('‚ö†Ô∏è No se pudieron cargar usuarios (tabla puede no existir)');
          renderUsers();
          showLoading(false);
          return;
        }

        users = result.data.map(u => ({
          id: u.id,
          username: u.username || (u.email ? u.email.split('@')[0] : 'N/A'),
          name: u.full_name || 'Sin nombre',
          full_name: u.full_name || 'Sin nombre',
          email: u.email || 'No disponible',
          phone: u.phone || 'No disponible',
          role: u.role || 'Sin rol',
          team: Array.isArray(u.groups) && u.groups.length ? u.groups[0] : 'Sin grupo',
          active: u.active !== false,
          password: '********',
          created_at: u.created_at || null
        }));

        console.log(`‚úÖ ${users.length} usuarios cargados desde Supabase:`, users);
        renderUsers();
        showLoading(false);
      } catch (err) {
        console.error('‚ùå Error al cargar usuarios:', err);
        users = [];
        renderUsers();
        showLoading(false);
      }
    }

    function renderUsers(filteredUsers = users) {
      const tbody = document.getElementById('usersTableBody');
      if (!tbody) {
        console.warn('No se encontr√≥ tbody con id "usersTableBody"');
        return;
      }

      tbody.innerHTML = '';
      const safeUsers = normalizeToArray(filteredUsers);

      safeUsers.forEach(user => {
        const row = document.createElement('tr');

        const tdUsername = document.createElement('td');
        tdUsername.textContent = user.username || '';
        row.appendChild(tdUsername);

        const tdName = document.createElement('td');
        tdName.textContent = user.name || '';
        row.appendChild(tdName);

        const tdEmail = document.createElement('td');
        const emailCell = (typeof createCensoredCell === 'function')
          ? createCensoredCell(user.email, visibleUsers.has(user.username))
          : (user.email || '');
        appendCellContent(tdEmail, emailCell);
        row.appendChild(tdEmail);

        const tdPhone = document.createElement('td');
        const phoneCell = (typeof createCensoredCell === 'function')
          ? createCensoredCell(user.phone, visibleUsers.has(user.username))
          : (user.phone || '');
        appendCellContent(tdPhone, phoneCell);
        row.appendChild(tdPhone);

        const tdRole = document.createElement('td');
        tdRole.textContent = user.role || '';
        row.appendChild(tdRole);

        const tdEquipo = document.createElement('td');
        tdEquipo.textContent = user.team || user.group || '';
        row.appendChild(tdEquipo);

        const tdEstado = document.createElement('td');
        tdEstado.innerHTML = (user.active !== false)
          ? '<span class="badge bg-success">Activo</span>'
          : '<span class="badge bg-danger">Inactivo</span>';
        row.appendChild(tdEstado);

        const tdPassword = document.createElement('td');
        const passwordCell = (typeof createPasswordCell === 'function')
          ? createPasswordCell(user.password, visibleUsers.has(user.username))
          : (user.password || '');
        appendCellContent(tdPassword, passwordCell);
        row.appendChild(tdPassword);

        const tdActions = document.createElement('td');
        const actionsDiv = document.createElement('div');
        actionsDiv.className = 'user-actions';

        const btnEdit = document.createElement('button');
        btnEdit.className = 'btn btn-sm btn-warning';
        btnEdit.title = 'Edici√≥n deshabilitada (solo lectura)';
        btnEdit.innerHTML = '<i class="bi bi-pencil-fill"></i>';
        btnEdit.disabled = true;

        const btnDelete = document.createElement('button');
        btnDelete.className = 'btn btn-sm btn-danger';
        btnDelete.title = 'Eliminaci√≥n deshabilitada (solo lectura)';
        btnDelete.innerHTML = '<i class="bi bi-trash-fill"></i>';
        btnDelete.disabled = true;

        const btnToggle = document.createElement('button');
        btnToggle.className = 'btn btn-sm btn-info';
        btnToggle.title = 'Ver/Ocultar';
        btnToggle.innerHTML = '<i class="bi bi-eye-fill"></i>';
        btnToggle.onclick = () => toggleUserVisibility(user.username);

        actionsDiv.appendChild(btnEdit);
        actionsDiv.appendChild(btnDelete);
        actionsDiv.appendChild(btnToggle);
        tdActions.appendChild(actionsDiv);
        row.appendChild(tdActions);

        tbody.appendChild(row);
      });
    }

    function filterUsers(query) {
      const q = (query || '').toLowerCase();
      const role = document.getElementById('roleFilter')?.value || '';

      const filtered = users.filter(u => {
        const matchesQuery = !q ||
          (u.username || '').toLowerCase().includes(q) ||
          (u.name || u.full_name || '').toLowerCase().includes(q) ||
          (u.email || '').toLowerCase().includes(q) ||
          (u.phone || '').toLowerCase().includes(q);

        const matchesRole = !role || (u.role || '') === role;

        return matchesQuery && matchesRole;
      });

      renderUsers(filtered);
    }

    function openAddModal() {
      alert('Gesti√≥n de usuarios es solo lectura en esta fase.');
    }

    function toggleUserVisibility(username) {
      if (visibleUsers.has(username)) {
        visibleUsers.delete(username);
      } else {
        visibleUsers.add(username);
      }
      renderUsers();
    }

    // Inicializar p√°gina protegida
    window.protectPage(() => {
      console.log('üé¨ Usuarios: Ejecutando inicializaci√≥n...');

      loadUsers();

      const searchInput = document.getElementById('searchInput');
      const roleFilter = document.getElementById('roleFilter');

      if (searchInput) {
        searchInput.addEventListener('input', (e) => filterUsers(e.target.value));
      }

      if (roleFilter) {
        roleFilter.addEventListener('change', () => filterUsers(document.getElementById('searchInput')?.value || ''));
      }

      const addUserBtn = document.getElementById('addUserBtn');
      if (addUserBtn) {
        addUserBtn.disabled = true;
        addUserBtn.title = 'Crear usuarios est√° deshabilitado (solo lectura).';
      }
    });
  </script>

  <!-- 9. Bootstrap JS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>

</html>