<!DOCTYPE html>
<html lang="es">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Integrova - Gestión de Usuarios</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css" rel="stylesheet">
  <link rel="stylesheet" href="../css/styles.css">
  <link rel="stylesheet" href="../css/usuarios.css">
  <!-- SDK Supabase v1 desde CDN -->
  <script src="https://unpkg.com/@supabase/supabase-js@1.35.7/dist/umd/supabase.min.js"></script>
  <!-- Configuración Supabase (debe cargarse ANTES del cliente) -->
  <script src="../js/config-supabase.js"></script>

</head>

<body>
  <header class="header-dashboard">
    <div class="header-left">
      <h1 class="page-title">Integrova - Usuarios</h1>
    </div>
    <div class="header-center">
      <div class="buscador">
        <i class="bi bi-search"></i>
        <input id="searchInput" type="text" placeholder="Buscar por usuario, nombre, correo o teléfono...">
      </div>
    </div>
    <div class="header-right">
      <select id="roleFilter" class="form-select filter-select">
        <option value="">Todos los roles</option>
        <option value="cliente">Cliente</option>
        <option value="auditor">Auditor</option>
        <option value="auditor_senior">Auditor Senior</option>
        <option value="supervisor">Supervisor</option>
        <option value="socio">Socio</option>
        <option value="administrador">Administrador</option>
        <option value="programador">Programador</option>
      </select>
      <button class="header-btn" id="addUserBtn" onclick="openAddModal()" title="Agregar Usuario">
        <i class="bi bi-person-plus"></i>
      </button>
      <button class="header-btn" onclick="window.location.href='dashboard.html'" title="Dashboard">
        <i class="bi bi-house"></i>
      </button>
      <button class="header-btn" id="logoutBtn" onclick="logout()" title="Salir">
        <i class="bi bi-box-arrow-right"></i>
      </button>
    </div>
  </header>

  <div class="main-container">
    <div class="usuarios-container">
      <div class="table-responsive">
        <table class="table table-striped table-hover" id="usersTable">
          <thead>
            <tr>
              <th>Usuario</th>
              <th>Nombre</th>
              <th>Correo</th>
              <th>Teléfono</th>
              <th>Rol</th>
              <th>Equipo</th>
              <th>Estado</th>
              <th>Contraseña</th>
              <th>Acciones</th>
            </tr>
          </thead>
          <tbody id="usersTableBody">
            <!-- Rows will be populated by JavaScript -->
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <div class="footer-full">
    <p>&copy; 2025 CFE INSIGHT. Sistema de Auditoría v1.0. Todos los derechos reservados.</p>
  </div>

  <!-- Modal for Add/Edit User (deshabilitado en esta fase) -->
  <div class="modal fade" id="userModal" tabindex="-1" aria-labelledby="userModalLabel" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="userModalLabel">Agregar Usuario</h5>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <p class="text-muted mb-0">Gestión de usuarios está en modo solo lectura.</p>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
          <button type="button" class="btn btn-primary" id="saveUserBtn" disabled>Guardar</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal for Delete Confirmation (solo lectura) -->
  <div class="modal fade" id="deleteModal" tabindex="-1" aria-labelledby="deleteModalLabel" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="deleteModalLabel">
            <i class="bi bi-exclamation-triangle text-warning"></i> Confirmar Eliminación
          </h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <p id="deleteModalMessage">¿Está seguro de eliminar al usuario?</p>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
          <button type="button" class="btn btn-danger" id="confirmDeleteBtn" disabled>Eliminar</button>
        </div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
  <script src="../js/utils.js"></script>
  <script>
    let users = [];
    let visibleUsers = new Set();
    let supabaseClientRef = null;
    let currentSession = window.appSession || null;

    async function getSupabase() {
      if (supabaseClientRef) return supabaseClientRef;
      if (window.supabaseClientPromise) {
        supabaseClientRef = await window.supabaseClientPromise;
      }
      if (!supabaseClientRef) {
        throw new Error('Supabase no está configurado en el frontend.');
      }
      return supabaseClientRef;
    }

    function normalizeToArray(value) {
      if (!value) return [];
      if (Array.isArray(value)) return value;
      if (typeof value === 'object') return [value];
      return [];
    }

    function appendCellContent(td, content) {
      if (!content && content !== 0) {
        td.textContent = '';
        return;
      }
      if (content instanceof Node) {
        td.appendChild(content);
      } else {
        td.innerHTML = String(content);
      }
    }

    async function fetchUsers() {
      try {
        const supabase = await getSupabase();
        const { data, error } = await supabase
          .from('users')
          .select('id, full_name, email, role, username, phone, groups');

        if (error) throw error;

        users = (data || []).map(u => ({
          id: u.id,
          username: u.username || (u.email ? u.email.split('@')[0] : 'N/A'),
          name: u.full_name || 'Sin nombre',
          full_name: u.full_name || 'Sin nombre',
          email: u.email || 'No disponible',
          phone: u.phone || 'No disponible',
          role: u.role || 'Sin rol',
          team: Array.isArray(u.groups) && u.groups.length ? u.groups[0] : 'Sin grupo',
          active: true,
          password: '********',
          created_at: null
        }));

        console.log(`✅ ${users.length} usuarios cargados desde Supabase:`, users);
        renderUsers();
      } catch (err) {
        console.error('❌ Error al cargar usuarios desde Supabase:', err);
        alert('Error al cargar usuarios: ' + (err.message || err));
      }
    }

    async function fetchCurrentProfile(authId) {
      const supabase = await getSupabase();
      const { data, error } = await supabase
        .from('users')
        .select('id, full_name, email, role, username, phone, groups')
        .eq('id', authId)
        .maybeSingle();

      if (error) {
        throw error;
      }

      return data;
    }

    async function checkAccess() {
      try {
        const supabase = await getSupabase();
        const { data: { session }, error } = await supabase.auth.getSession();

        if (error || !session) {
          window.location.href = 'login.html';
          return false;
        }

        const cached = sessionStorage.getItem('userUI');
        if (cached) {
          try {
            currentSession = JSON.parse(cached);
          } catch (e) {
            console.error('Error parsing cached session:', e);
            currentSession = null;
          }
        }

        if (!currentSession) {
          const profile = await fetchCurrentProfile(session.user.id);
          if (!profile) {
            alert('No se encontró tu perfil en la tabla users. Contacta a un administrador.');
            await supabase.auth.signOut();
            window.location.href = 'login.html';
            return false;
          }

          currentSession = {
            id: profile.id,
            name: profile.full_name || session.user?.user_metadata?.full_name || session.user?.email,
            email: profile.email || session.user?.email,
            role: profile.role || 'usuario',
            username: profile.username || session.user?.user_metadata?.username || null,
            phone: profile.phone ?? null,
            groups: Array.isArray(profile.groups)
              ? profile.groups
              : profile.groups
                ? [profile.groups]
                : []
          };

          sessionStorage.setItem('userUI', JSON.stringify(currentSession));
          window.appSession = currentSession;
        }

        if (!['administrador', 'programador', 'socio'].includes(currentSession.role)) {
          alert('No tienes permisos para acceder a esta página');
          window.location.href = 'dashboard.html';
          return false;
        }

        return true;
      } catch (e) {
        console.error('Error verificando acceso:', e);
        window.location.href = 'login.html';
        return false;
      }
    }

    function renderUsers(filteredUsers = users) {
      const tbody = document.getElementById('usersTableBody');
      if (!tbody) {
        console.warn('No se encontró tbody con id "usersTableBody"');
        return;
      }

      tbody.innerHTML = '';

      const safeUsers = normalizeToArray(filteredUsers);

      safeUsers.forEach(user => {
        const row = document.createElement('tr');

        const tdUsername = document.createElement('td');
        tdUsername.textContent = user.username || '';
        row.appendChild(tdUsername);

        const tdName = document.createElement('td');
        tdName.textContent = user.name || '';
        row.appendChild(tdName);

        const tdEmail = document.createElement('td');
        const emailCell = (typeof createCensoredCell === 'function')
          ? createCensoredCell(user.email, visibleUsers.has(user.username))
          : (user.email || '');
        appendCellContent(tdEmail, emailCell);
        row.appendChild(tdEmail);

        const tdPhone = document.createElement('td');
        const phoneCell = (typeof createCensoredCell === 'function')
          ? createCensoredCell(user.phone, visibleUsers.has(user.username))
          : (user.phone || '');
        appendCellContent(tdPhone, phoneCell);
        row.appendChild(tdPhone);

        const tdRole = document.createElement('td');
        tdRole.textContent = user.role || '';
        row.appendChild(tdRole);

        const tdEquipo = document.createElement('td');
        tdEquipo.textContent = user.team || user.group || '';
        row.appendChild(tdEquipo);

        const tdEstado = document.createElement('td');
        tdEstado.innerHTML = (user.active !== false)
          ? '<span class="badge bg-success">Activo</span>'
          : '<span class="badge bg-danger">Inactivo</span>';
        row.appendChild(tdEstado);

        const tdPassword = document.createElement('td');
        const passwordCell = (typeof createPasswordCell === 'function')
          ? createPasswordCell(user.password, visibleUsers.has(user.username))
          : (user.password || '');
        appendCellContent(tdPassword, passwordCell);
        row.appendChild(tdPassword);

        const tdActions = document.createElement('td');
        const actionsDiv = document.createElement('div');
        actionsDiv.className = 'user-actions';

        const btnEdit = document.createElement('button');
        btnEdit.className = 'btn btn-sm btn-warning';
        btnEdit.title = 'Edición deshabilitada (solo lectura)';
        btnEdit.innerHTML = '<i class="bi bi-pencil-fill"></i>';
        btnEdit.disabled = true;

        const btnDelete = document.createElement('button');
        btnDelete.className = 'btn btn-sm btn-danger';
        btnDelete.title = 'Eliminación deshabilitada (solo lectura)';
        btnDelete.innerHTML = '<i class="bi bi-trash-fill"></i>';
        btnDelete.disabled = true;

        const btnToggle = document.createElement('button');
        btnToggle.className = 'btn btn-sm btn-info';
        btnToggle.title = 'Ver/Ocultar';
        btnToggle.innerHTML = '<i class="bi bi-eye-fill"></i>';
        btnToggle.onclick = () => toggleUserVisibility(user.username);

        actionsDiv.appendChild(btnEdit);
        actionsDiv.appendChild(btnDelete);
        actionsDiv.appendChild(btnToggle);
        tdActions.appendChild(actionsDiv);
        row.appendChild(tdActions);

        tbody.appendChild(row);
      });
    }

    function filterUsers(query) {
      const q = (query || '').toLowerCase();
      const role = document.getElementById('roleFilter')?.value || '';

      const filtered = users.filter(u => {
        const matchesQuery = !q ||
          (u.username || '').toLowerCase().includes(q) ||
          (u.name || u.full_name || '').toLowerCase().includes(q) ||
          (u.email || '').toLowerCase().includes(q) ||
          (u.phone || '').toLowerCase().includes(q);

        const matchesRole = !role || (u.role || '') === role;

        return matchesQuery && matchesRole;
      });

      renderUsers(filtered);
    }

    function openAddModal() {
      alert('Gestión de usuarios es solo lectura en esta fase.');
    }

    function editUser() {
      alert('Edición deshabilitada temporalmente (solo lectura).');
    }

    async function saveUser() {
      alert('Crear/editar usuarios no está disponible en esta fase (solo lectura).');
    }

    function deleteUser() {
      alert('Eliminación deshabilitada en esta fase (solo lectura).');
    }

    function toggleUserVisibility(username) {
      if (visibleUsers.has(username)) {
        visibleUsers.delete(username);
      } else {
        visibleUsers.add(username);
      }
      renderUsers();
    }

    async function logout() {
      sessionStorage.removeItem('userUI');
      window.appSession = null;
      try {
        const supabase = await getSupabase();
        await supabase.auth.signOut();
      } catch (err) {
        console.error('Error al cerrar sesión en Supabase:', err);
      }
      window.location.href = 'login.html';
    }

    document.addEventListener('DOMContentLoaded', async () => {
      const hasAccess = await checkAccess();
      if (!hasAccess) return;

      const addUserBtn = document.getElementById('addUserBtn');
      if (addUserBtn) {
        addUserBtn.disabled = true;
        addUserBtn.title = 'Crear usuarios está deshabilitado en esta fase (solo lectura).';
      }

      await fetchUsers();

      const searchInput = document.getElementById('searchInput');
      const roleFilter = document.getElementById('roleFilter');
      if (searchInput) searchInput.addEventListener('input', (e) => filterUsers(e.target.value));
      if (roleFilter) roleFilter.addEventListener('change', () => filterUsers(document.getElementById('searchInput')?.value || ''));

      const saveUserBtn = document.getElementById('saveUserBtn');
      if (saveUserBtn) saveUserBtn.addEventListener('click', saveUser);

      const togglePasswordBtn = document.getElementById('togglePasswordModal');
      if (togglePasswordBtn) {
        togglePasswordBtn.addEventListener('click', () => {
          const passwordInput = document.getElementById('password');
          passwordInput.type = passwordInput.type === 'password' ? 'text' : 'password';
        });
      }
    });
  </script>

  <!-- Auth Guard -->
  <script src="../js/auth-guard.js"></script>
  <script>
    document.addEventListener('DOMContentLoaded', async () => {
      if (typeof initAuthGuard === 'function') {
        await initAuthGuard('logoutBtn');
      }
    });
  </script>
</body>

</html>