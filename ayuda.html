<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ayuda - CFE INSIGHT</title>
    <link rel="icon" href="assets/logoinsightdorado.png" type="image/x-icon">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css" rel="stylesheet">
    <link rel="stylesheet" href="css/styles.css">
    <link rel="stylesheet" href="css/ayuda.css">
</head>

<body>
    <header class="header">
        <button class="btn-back" onclick="window.location.href='dashboard.html'">
            <i class="bi bi-arrow-left"></i> Volver
        </button>
        <h2 class="welcome-text" id="welcomeText">Bienvenido, Usuario</h2>
        <button class="btn-logout" onclick="logout()">
            <i class="bi bi-box-arrow-right"></i> Salir
        </button>
    </header>

    <!-- Toggle Tema Oscuro/Claro -->
    <button class="theme-toggle" onclick="toggleTheme()">
        <i class="bi bi-moon"></i>
    </button>

    <div class="main-container">
        <div class="ayuda-container">
            <div class="ayuda-header">
                <h1 class="ayuda-title">Ayuda y Soporte</h1>
                <p class="ayuda-subtitle">
                    Encuentra respuestas a tus preguntas, contacta con nuestro equipo de soporte y accede a recursos
                    útiles para maximizar tu experiencia con CFE INSIGHT.
                </p>
            </div>

            <!-- Navegación rápida -->
            <div class="navegacion-rapida">
                <div class="nav-card" onclick="window.location.href='entidades.html'">
                    <i class="bi bi-building"></i>
                    <h5>Entidades</h5>
                    <p>Gestiona y administra las entidades del sistema</p>
                </div>
                <div class="nav-card" onclick="window.location.href='compromisos.html'">
                    <i class="bi bi-clipboard-check"></i>
                    <h5>Compromisos</h5>
                    <p>Visualiza y administra los compromisos activos</p>
                </div>
                <div class="nav-card" onclick="window.location.href='grupos.html'">
                    <i class="bi bi-people-fill"></i>
                    <h5>Grupos</h5>
                    <p>Organiza y gestiona los equipos de trabajo</p>
                </div>
                <div class="nav-card" onclick="window.location.href='registros.html'">
                    <i class="bi bi-graph-up"></i>
                    <h5>Reportes</h5>
                    <p>Genera y visualiza reportes del sistema</p>
                </div>
                <div class="nav-card" onclick="window.location.href='usuarios.html'">
                    <i class="bi bi-person-plus"></i>
                    <h5>Usuarios</h5>
                    <p>Administra usuarios y permisos</p>
                </div>
                <div class="nav-card" onclick="window.location.href='soporte_ia.html'">
                    <i class="bi bi-robot"></i>
                    <h5>Soporte IA</h5>
                    <p>Asistente inteligente para consultas</p>
                </div>
            </div>

            <!-- Sección de Contacto -->
            <div class="contacto-section">
                <h2 class="contacto-title">¿Necesitas Ayuda Personalizada?</h2>
                <div class="contacto-grid">
                    <div class="contacto-card email">
                        <i class="bi bi-envelope-fill"></i>
                        <h5>Correo Electrónico</h5>
                        <p>Envía un email con tu consulta detallada y te responderemos lo antes posible.</p>
                        <p><strong>gaexterno@outlook.com</strong></p>
                    </div>
                    <div class="contacto-card phone">
                        <i class="bi bi-telephone-fill"></i>
                        <h5>Teléfono</h5>
                        <p>Llama para soporte inmediato durante horario laboral.</p>
                        <p><strong>+52 55 1234 5678</strong></p>
                    </div>
                </div>

                <button class="chat-btn" onclick="window.location.href='chat.html'">
                    <i class="bi bi-chat-dots"></i> Iniciar Chat con Programador
                </button>
            </div>

            <!-- Información Adicional -->
            <div class="info-adicional">
                <h5><i class="bi bi-info-circle"></i> Información Adicional</h5>
                <p>
                    Para consultas relacionadas con auditorías o procesos específicos, utiliza el <strong>Soporte
                        IA</strong> disponible desde el dashboard principal.
                    Para problemas técnicos, desarrollo de nuevas funcionalidades o soporte avanzado, utiliza los
                    canales de contacto de programadores.
                    Nuestro equipo está comprometido en brindarte la mejor experiencia posible con CFE INSIGHT.
                </p>
            </div>

            <!-- Sección para programadores -->
            <div id="programadorSection" class="mt-5" style="display: none;">
                <h3 class="text-center mb-4"><i class="bi bi-code-slash"></i> Panel de Programador</h3>
                <div class="alert alert-info">
                    <h5><i class="bi bi-info-circle"></i> Gestión de Solicitudes de Soporte</h5>
                    <p>Aquí puedes ver y responder todas las consultas de usuarios que requieren asistencia técnica.</p>
                </div>

                <!-- Filtros -->
                <div class="row mb-4">
                    <div class="col-md-4">
                        <select id="filtroEstado" class="form-select">
                            <option value="todas">Todas</option>
                            <option value="pendiente">Pendientes</option>
                            <option value="resuelta">Resueltas</option>
                        </select>
                    </div>
                    <div class="col-md-4">
                        <input type="date" id="filtroFecha" class="form-control">
                    </div>
                    <div class="col-md-4">
                        <input type="text" id="filtroUsuario" class="form-control" placeholder="Buscar por usuario">
                    </div>
                </div>

                <!-- Solicitudes pendientes -->
                <div class="card mb-4">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5><i class="bi bi-list-check"></i> Solicitudes Pendientes (<span
                                id="countPendientes">0</span>)</h5>
                        <button class="btn btn-sm btn-outline-primary"
                            onclick="refreshSolicitudes()">Actualizar</button>
                    </div>
                    <div class="card-body">
                        <div id="solicitudesList" class="list-group">
                            <!-- Solicitudes se cargan aquí -->
                        </div>
                    </div>
                </div>

                <!-- Historial de resueltas -->
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5><i class="bi bi-check-circle"></i> Historial de Solicitudes (<span
                                id="countResueltas">0</span>)</h5>
                    </div>
                    <div class="card-body">
                        <div id="historialSolicitudes" class="list-group">
                            <!-- Historial se carga aquí -->
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="footer-full">
        <p>&copy; 2025 CFE INSIGHT. Sistema de Auditoría v1.0. Todos los derechos reservados.</p>
    </div>

    <!-- Modal para responder consultas -->
    <div class="modal fade" id="responseModal" tabindex="-1" style="z-index: 9999 !important;">
        <div class="modal-dialog modal-lg" style="z-index: 10000 !important;">
            <div class="modal-content" style="z-index: 10001 !important;">
                <div class="modal-header">
                    <h5 class="modal-title">Responder Consulta</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"
                        onclick="forceCloseModal()"></button>
                </div>
                <div class="modal-body">
                    <div id="requestDetails" class="mb-4">
                        <!-- Detalles de la consulta se mostrarán aquí -->
                    </div>
                    <div class="form-group">
                        <label for="responseText" class="form-label">Tu Respuesta</label>
                        <textarea class="form-control" id="responseText" rows="6"
                            placeholder="Escribe tu respuesta detallada..."></textarea>
                    </div>
                    <div class="form-check mt-3">
                        <input class="form-check-input" type="checkbox" id="markResolved">
                        <label class="form-check-label" for="markResolved">
                            Marcar como resuelta
                        </label>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal"
                        onclick="forceCloseModal()">Cancelar</button>
                    <button type="button" class="btn btn-primary" onclick="sendResponse()">Enviar Respuesta</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="js/utils.js"></script>
    <script>
        // Toggle Tema Oscuro/Claro
        function toggleTheme() {
            const body = document.body;
            const toggleBtn = document.querySelector('.theme-toggle i');
            body.classList.toggle('dark-theme');
            if (body.classList.contains('dark-theme')) {
                toggleBtn.className = 'bi bi-sun';
                localStorage.setItem('theme', 'dark');
            } else {
                toggleBtn.className = 'bi bi-moon';
                localStorage.setItem('theme', 'light');
            }
        }

        // Aplicar tema guardado
        document.addEventListener('DOMContentLoaded', function () {
            const savedTheme = localStorage.getItem('theme');
            if (savedTheme === 'dark') {
                document.body.classList.add('dark-theme');
                document.querySelector('.theme-toggle i').className = 'bi bi-sun';
            }

            // Verificar sesión
            const userData = getCurrentSession();
            if (!userData) {
                window.location.href = 'login.html';
                return;
            }
            document.getElementById('welcomeText').textContent = `Bienvenido, ${userData.name}`;

            // Verificar si es programador y mostrar panel
            if (userData.role === 'programador') {
                document.getElementById('programadorSection').style.display = 'block';
                loadSolicitudes();
            }
        });

        // Logout
        function logout() {
            localStorage.removeItem('userSession');
            window.location.href = 'login.html';
        }

        // Funciones para el panel de programador
        function loadSolicitudes() {
            const solicitudes = JSON.parse(localStorage.getItem('solicitudesAyuda') || '[]');
            const pendientes = solicitudes.filter(s => s.estado === 'pendiente');
            const resueltas = solicitudes.filter(s => s.estado === 'resuelta');

            document.getElementById('countPendientes').textContent = pendientes.length;
            document.getElementById('countResueltas').textContent = resueltas.length;

            renderSolicitudes(pendientes, 'solicitudesList');
            renderSolicitudes(resueltas, 'historialSolicitudes', true);
        }

        function renderSolicitudes(solicitudes, containerId, isHistorial = false) {
            const container = document.getElementById(containerId);
            container.innerHTML = '';

            if (solicitudes.length === 0) {
                container.innerHTML = '<div class="text-center text-muted p-4"><i class="bi bi-inbox" style="font-size: 3rem;"></i><p>' + (isHistorial ? 'No hay solicitudes resueltas' : 'No hay solicitudes pendientes') + '</p></div>';
                return;
            }

            solicitudes.forEach((solicitud, index) => {
                const item = document.createElement('div');
                item.className = 'list-group-item ' + (isHistorial ? '' : 'list-group-item-action');
                item.onclick = isHistorial ? null : () => openResponseModal(solicitud);
                item.innerHTML = `
                <div class="d-flex w-100 justify-content-between">
                    <h6 class="mb-1">${solicitud.titulo || 'Solicitud sin título'}</h6>
                    <small class="text-${isHistorial ? 'success' : 'warning'}">${isHistorial ? 'Resuelta' : 'Pendiente'}</small>
                </div>
                <p class="mb-1">${solicitud.mensaje.substring(0, 100)}${solicitud.mensaje.length > 100 ? '...' : ''}</p>
                <small class="text-muted">Por: ${solicitud.usuario} | ${new Date(solicitud.fecha).toLocaleString()}</small>
                ${!isHistorial ? '<hr><small class="text-primary">Click para responder</small>' : ''}
            `;
                container.appendChild(item);
            });
        }

        function openResponseModal(solicitud) {
            document.getElementById('requestDetails').innerHTML = `
            <h6>${solicitud.titulo || 'Solicitud sin título'}</h6>
            <p><strong>Usuario:</strong> ${solicitud.usuario}</p>
            <p><strong>Fecha:</strong> ${new Date(solicitud.fecha).toLocaleString()}</p>
            <hr>
            <p><strong>Mensaje:</strong></p>
            <p class="mb-0">${solicitud.mensaje}</p>
        `;
            document.getElementById('responseText').value = solicitud.respuesta || '';
            document.getElementById('markResolved').checked = solicitud.estado === 'resuelta';
            new bootstrap.Modal(document.getElementById('responseModal')).show();
            window.currentSolicitud = solicitud; // Para referencia en sendResponse
        }

        function sendResponse() {
            const respuesta = document.getElementById('responseText').value.trim();
            const markResolved = document.getElementById('markResolved').checked;

            if (!respuesta) {
                alert('Por favor, escribe una respuesta.');
                return;
            }

            // Actualizar solicitud
            window.currentSolicitud.respuesta = respuesta;
            window.currentSolicitud.estado = markResolved ? 'resuelta' : 'pendiente';
            window.currentSolicitud.fechaRespuesta = new Date().toISOString();

            // Guardar en localStorage
            const solicitudes = JSON.parse(localStorage.getItem('solicitudesAyuda') || '[]');
            const index = solicitudes.findIndex(s => s.id === window.currentSolicitud.id);
            if (index > -1) {
                solicitudes[index] = window.currentSolicitud;
            }
            localStorage.setItem('solicitudesAyuda', JSON.stringify(solicitudes));

            // Cerrar modal y recargar
            bootstrap.Modal.getInstance(document.getElementById('responseModal')).hide();
            loadSolicitudes();
            showNotification('Respuesta enviada exitosamente', 'success');
        }

        function forceCloseModal() {
            bootstrap.Modal.getInstance(document.getElementById('responseModal')).hide();
        }

        function refreshSolicitudes() {
            loadSolicitudes();
            showNotification('Solicitudes actualizadas', 'info');
        }

        // Filtros (simplificado para demo)
        document.getElementById('filtroEstado').addEventListener('change', loadSolicitudes);
        document.getElementById('filtroFecha').addEventListener('change', loadSolicitudes);
        document.getElementById('filtroUsuario').addEventListener('input', loadSolicitudes);

        // Función para mostrar notificaciones
        function showNotification(message, type = 'info') {
            const alertDiv = document.createElement('div');
            alertDiv.className = `alert alert-${type} alert-dismissible fade show position-fixed`;
            alertDiv.style.cssText = 'top: 20px; right: 20px; z-index: 1060; min-width: 300px;';
            alertDiv.innerHTML = `
            ${message}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        `;
            document.body.appendChild(alertDiv);

            setTimeout(() => {
                if (alertDiv.parentNode) alertDiv.remove();
            }, 5000);
        }

        // Demo data (agregar algunas solicitudes de ejemplo si no hay)
        if (!localStorage.getItem('solicitudesAyuda')) {
            const demoSolicitudes = [
                {
                    id: 1,
                    titulo: 'Error en el dashboard',
                    mensaje: 'El dashboard no carga correctamente después del login.',
                    usuario: 'Usuario1',
                    fecha: new Date(Date.now() - 86400000).toISOString(), // Ayer
                    estado: 'pendiente',
                    respuesta: ''
                },
                {
                    id: 2,
                    titulo: 'Pregunta sobre auditorías',
                    mensaje: 'Cómo generar reportes de auditoría personalizados?',
                    usuario: 'Usuario2',
                    fecha: new Date(Date.now() - 2 * 86400000).toISOString(),
                    estado: 'resuelta',
                    respuesta: 'Puedes usar la funcionalidad de Soporte IA para generar reportes personalizados.',
                    fechaRespuesta: new Date().toISOString()
                }
            ];
            localStorage.setItem('solicitudesAyuda', JSON.stringify(demoSolicitudes));
        }
    </script>
</body>

</html>