<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Integrova - Gestión de Equipos</title>
    <link rel="icon" href="assets/logoinsightdorado.png" type="image/x-icon">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css" rel="stylesheet">
    <link rel="stylesheet" href="css/styles.css">
    <link rel="stylesheet" href="css/grupos.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
</head>

<body>
    <header class="header-dashboard">
        <div class="header-left">
            <h1 class="page-title">Integrova - Equipos</h1>
        </div>
        <div class="header-center">
            <div class="buscador">
                <i class="bi bi-search"></i>
                <input id="searchInput" type="text" placeholder="Buscar equipos...">
            </div>
        </div>
        <div class="header-right">
            <button class="header-btn" id="addGroupBtn" onclick="openAddGroupModal()" title="Crear Equipo">
                <i class="bi bi-people-fill"></i>
            </button>
            <button class="header-btn" onclick="window.location.href='dashboard.html'" title="Dashboard">
                <i class="bi bi-house"></i>
            </button>
            <button class="header-btn" onclick="logout()" title="Salir">
                <i class="bi bi-box-arrow-right"></i>
            </button>
        </div>
    </header>

    <div class="main-container">
        <div class="grupos-container">
            <div id="groupsList" class="groups-grid">
                <!-- Cards se generan via JS -->
            </div>
            <div id="noResults" class="no-results" style="display: none;">
                <i class="bi bi-inbox"></i>
                <p>No hay equipos que coincidan con la búsqueda.</p>
            </div>
        </div>
    </div>

    <div class="footer-full">
        <p>&copy; 2025 Integrova. Sistema de Auditoría v1.0. Todos los derechos reservados.</p>
    </div>

    <!-- Modal for Add/Edit Group -->
    <div class="modal fade" id="groupModal" tabindex="-1" aria-labelledby="groupModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-xl" style="max-width: 90vw;">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="groupModalLabel">Crear Equipo</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="groupForm">
                        <div class="row">
                            <div class="col-md-12">
                                <div class="mb-3">
                                    <label for="groupName" class="form-label">Nombre del Equipo *</label>
                                    <input type="text" class="form-control" id="groupName" required
                                        placeholder="Ej: Equipo de Auditoría Financiera">
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-12">
                                <div class="mb-3">
                                    <label for="groupDescription" class="form-label">Descripción</label>
                                    <textarea class="form-control" id="groupDescription" rows="2"
                                        placeholder="Breve descripción del equipo y sus responsabilidades"></textarea>
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">Miembros del Equipo</label>
                                    <div id="membersList" class="border rounded p-2"
                                        style="min-height: 150px; max-height: 250px; overflow-y: auto; background-color: #f8f9fa;">
                                        <p class="text-muted text-center m-2">No hay miembros asignados</p>
                                    </div>
                                    <button type="button" class="btn btn-sm btn-outline-primary mt-2 w-100"
                                        onclick="openAddMemberModal()">
                                        <i class="bi bi-person-plus"></i> Agregar Miembro
                                    </button>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">Compromisos Asignados</label>
                                    <div id="commitmentsList" class="border rounded p-2"
                                        style="min-height: 150px; max-height: 250px; overflow-y: auto; background-color: #f8f9fa;">
                                        <p class="text-muted text-center m-2">No hay compromisos asignados</p>
                                    </div>
                                    <button type="button" class="btn btn-sm btn-outline-primary mt-2 w-100"
                                        onclick="openAddCommitmentModal()">
                                        <i class="bi bi-clipboard-plus"></i> Asignar Compromiso
                                    </button>
                                </div>
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="button" class="btn btn-primary" onclick="saveGroup()">Guardar</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal for Add Member -->
    <div class="modal fade" id="addMemberModal" tabindex="-1" aria-labelledby="addMemberModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="addMemberModalLabel">Agregar Miembro</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="memberSelect" class="form-label">Seleccionar Usuario</label>
                        <select class="form-control" id="memberSelect">
                            <!-- Options populated by JS -->
                        </select>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="button" class="btn btn-primary" onclick="addMemberToGroup()">Agregar</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal for Add Commitment -->
    <div class="modal fade" id="addCommitmentModal" tabindex="-1" aria-labelledby="addCommitmentModalLabel"
        aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="addCommitmentModalLabel">Asignar Compromiso</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="commitmentSelect" class="form-label">Seleccionar Compromiso</label>
                        <select class="form-control" id="commitmentSelect">
                            <!-- Options populated by JS -->
                        </select>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="button" class="btn btn-primary" onclick="addCommitmentToGroup()">Asignar</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal for Delete Confirmation -->
    <div class="modal fade" id="deleteModal" tabindex="-1" aria-labelledby="deleteModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="deleteModalLabel">
                        <i class="bi bi-exclamation-triangle text-warning"></i> Confirmar Eliminación
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <p id="deleteModalMessage">¿Está seguro de eliminar este equipo?</p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="button" class="btn btn-danger" id="confirmDeleteBtn">Eliminar</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal for Group Details -->
    <div class="modal fade" id="detailsModal" tabindex="-1" aria-labelledby="detailsModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="detailsModalLabel">
                        <i class="bi bi-info-circle text-primary"></i> Detalles del Equipo
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body" id="detailsModalBody">
                    <!-- Content will be populated by JS -->
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Alert Container -->
    <div id="alertContainer"></div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="js/utils.js"></script>
    <script src="js/api-client.js"></script>
    <script>
        let groups = [];
        let users = [];
        let commitments = [];
        let editingGroup = null;
        let currentGroupMembers = [];
        let currentGroupCommitments = [];

        // Initialize data from API
        async function initializeData() {
            try {
                showLoading(true);

                // Load groups from API
                const groupsResponse = await API.WorkGroups.getAll();
                if (groupsResponse.success && groupsResponse.data) {
                    const apiGroups = Array.isArray(groupsResponse.data) ? groupsResponse.data :
                        (groupsResponse.data.data ? groupsResponse.data.data : []);
                    groups = apiGroups.map(g => ({
                        id: g.id,
                        name: g.name,
                        description: g.description,
                        members: g.members || [],
                        commitments: g.commitments || []
                    }));
                } else {
                    showError('Error al cargar equipos: ' + (groupsResponse.error || 'Error desconocido'));
                    groups = [];
                }

                // Load users from API
                const usersResponse = await API.Usuarios.getAll();
                if (usersResponse.success && usersResponse.data) {
                    users = Array.isArray(usersResponse.data) ? usersResponse.data : [];
                } else {
                    showError('Error al cargar usuarios: ' + (usersResponse.error || 'Error desconocido'));
                    users = [];
                }

                // Load commitments from API
                const commitmentsResponse = await API.Commitments.getAll();
                if (commitmentsResponse.success && commitmentsResponse.data) {
                    const apiCommitments = Array.isArray(commitmentsResponse.data) ? commitmentsResponse.data :
                        (commitmentsResponse.data.data ? commitmentsResponse.data.data : []);
                    commitments = apiCommitments.map(c => ({
                        id: c.id,
                        name: c.title || c.name || 'Compromiso sin nombre'
                    }));
                } else {
                    showError('Error al cargar compromisos: ' + (commitmentsResponse.error || 'Error desconocido'));
                    commitments = [];
                }
            } catch (error) {
                console.error('Error loading data:', error);
                showError('Error al cargar los datos: ' + error.message);
            } finally {
                showLoading(false);
            }
        }

        // Check access (only administrators and programmers)
        function checkAccess() {
            const userData = getCurrentSession();
            if (!userData) {
                window.location.href = 'login.html';
                return;
            }
            const role = userData.role;
            if (role !== 'administrador' && role !== 'programador' && role !== 'socio') {
                alert('Acceso denegado. Solo administradores, programadores y socios pueden gestionar equipos.');
                window.location.href = 'dashboard.html';
                return;
            }
        }

        // Render groups
        function renderGroups(filteredGroups = groups) {
            const container = document.getElementById('groupsList');
            container.innerHTML = filteredGroups.map(createGroupCard).join('');
            document.getElementById('noResults').style.display = filteredGroups.length === 0 ? 'block' : 'none';
        }

        // Create group card
        function createGroupCard(group) {
            const membersCount = group.members ? group.members.length : 0;
            const commitmentsCount = group.commitments ? group.commitments.length : 0;

            return `
            <div class="group-card">
                <h3>${group.name}</h3>
                <p>${group.description || 'Sin descripción'}</p>
                <div class="group-stats">
                    <span><i class="bi bi-people"></i> ${membersCount} miembros</span>
                    <span><i class="bi bi-clipboard-check"></i> ${commitmentsCount} compromisos</span>
                </div>
                <div class="card-actions">
                    <button class="action-btn btn-primary" onclick="viewGroupDetails(${group.id})">
                        <i class="bi bi-eye"></i> Ver
                    </button>
                    <button class="action-btn btn-secondary" onclick="editGroup(${group.id})">
                        <i class="bi bi-pencil"></i> Editar
                    </button>
                    <button class="action-btn btn-danger" onclick="deleteGroup(${group.id})">
                        <i class="bi bi-trash"></i> Eliminar
                    </button>
                </div>
            </div>
        `;
        }

        // Filter groups
        function filterGroups() {
            const searchTerm = document.getElementById('searchInput').value.toLowerCase().trim();
            const filtered = groups.filter(group =>
                group.name.toLowerCase().includes(searchTerm) ||
                (group.description && group.description.toLowerCase().includes(searchTerm))
            );
            renderGroups(filtered);
        }

        // Open add group modal
        function openAddGroupModal() {
            editingGroup = null;
            currentGroupMembers = [];
            currentGroupCommitments = [];
            document.getElementById('groupModalLabel').textContent = 'Crear Equipo';
            document.getElementById('groupForm').reset();
            updateMembersList();
            updateCommitmentsList();
            new bootstrap.Modal(document.getElementById('groupModal')).show();
        }

        // Edit group
        function editGroup(id) {
            const group = groups.find(g => g.id === id);
            if (group) {
                editingGroup = group;
                currentGroupMembers = group.members || [];
                currentGroupCommitments = group.commitments || [];
                document.getElementById('groupModalLabel').textContent = 'Editar Equipo';
                document.getElementById('groupName').value = group.name;
                document.getElementById('groupDescription').value = group.description || '';
                updateMembersList();
                updateCommitmentsList();
                new bootstrap.Modal(document.getElementById('groupModal')).show();
            }
        }

        // Update members list in modal
        function updateMembersList() {
            const container = document.getElementById('membersList');
            if (currentGroupMembers.length === 0) {
                container.innerHTML = '<p class="text-muted text-center m-2"><i class="bi bi-person-x"></i> No hay miembros</p>';
                return;
            }

            container.innerHTML = currentGroupMembers.map(username => {
                const user = users.find(u => (u.username || u.email || u.id) === username);
                const name = user ? (user.name || user.full_name || user.username || user.email || 'Usuario') : username;
                return `
                    <div class="d-flex justify-content-between align-items-center mb-2 p-2 bg-white rounded border">
                        <div><strong>${name}</strong></div>
                        <button type="button" class="btn btn-sm btn-outline-danger" onclick="removeMember('${username}')">
                            <i class="bi bi-trash"></i>
                        </button>
                    </div>
                `;
            }).join('');
        }

        // Update commitments list in modal
        function updateCommitmentsList() {
            const container = document.getElementById('commitmentsList');
            if (currentGroupCommitments.length === 0) {
                container.innerHTML = '<p class="text-muted text-center m-2"><i class="bi bi-clipboard-x"></i> No hay compromisos</p>';
                return;
            }

            container.innerHTML = currentGroupCommitments.map(id => {
                const commitment = commitments.find(c => c.id === id);
                const name = commitment ? commitment.name : `Compromiso ${id}`;
                return `
                    <div class="d-flex justify-content-between align-items-center mb-2 p-2 bg-white rounded border">
                        <div><strong>${name}</strong></div>
                        <button type="button" class="btn btn-sm btn-outline-danger" onclick="removeCommitment(${id})">
                            <i class="bi bi-trash"></i>
                        </button>
                    </div>
                `;
            }).join('');
        }

        // Open add member modal
        function openAddMemberModal() {
            const select = document.getElementById('memberSelect');
            select.innerHTML = '<option value="">Seleccionar usuario...</option>';

            if (!users || users.length === 0) {
                select.innerHTML += '<option value="" disabled>No hay usuarios disponibles</option>';
                new bootstrap.Modal(document.getElementById('addMemberModal')).show();
                return;
            }

            users.forEach(user => {
                const username = user.username || user.email || user.id;
                const displayName = user.name || user.full_name || user.username || user.email || 'Usuario sin nombre';

                if (!currentGroupMembers.includes(username)) {
                    const option = document.createElement('option');
                    option.value = username;
                    option.textContent = `${displayName}`;
                    select.appendChild(option);
                }
            });
            new bootstrap.Modal(document.getElementById('addMemberModal')).show();
        }

        // Add member to group
        function addMemberToGroup() {
            const select = document.getElementById('memberSelect');
            const username = select.value;
            if (username && !currentGroupMembers.includes(username)) {
                currentGroupMembers.push(username);
                updateMembersList();
                bootstrap.Modal.getInstance(document.getElementById('addMemberModal')).hide();
            }
        }

        // Remove member from group
        function removeMember(username) {
            currentGroupMembers = currentGroupMembers.filter(u => u !== username);
            updateMembersList();
        }

        // Open add commitment modal
        function openAddCommitmentModal() {
            const select = document.getElementById('commitmentSelect');
            select.innerHTML = '<option value="">Seleccionar compromiso...</option>';
            commitments.forEach(commitment => {
                if (!currentGroupCommitments.includes(commitment.id)) {
                    const option = document.createElement('option');
                    option.value = commitment.id;
                    option.textContent = commitment.name;
                    select.appendChild(option);
                }
            });
            new bootstrap.Modal(document.getElementById('addCommitmentModal')).show();
        }

        // Add commitment to group
        function addCommitmentToGroup() {
            const select = document.getElementById('commitmentSelect');
            const id = parseInt(select.value);
            if (id && !currentGroupCommitments.includes(id)) {
                currentGroupCommitments.push(id);
                updateCommitmentsList();
                bootstrap.Modal.getInstance(document.getElementById('addCommitmentModal')).hide();
            }
        }

        // Remove commitment from group
        function removeCommitment(id) {
            currentGroupCommitments = currentGroupCommitments.filter(c => c !== id);
            updateCommitmentsList();
        }

        // Save group
        async function saveGroup() {
            const name = sanitizeInput(document.getElementById('groupName').value.trim());
            const description = sanitizeInput(document.getElementById('groupDescription').value.trim());

            if (!name) {
                showError('El nombre del equipo es obligatorio.');
                return;
            }

            const currentUser = getCurrentSession();
            if (!currentUser) {
                showError('Sesión expirada');
                window.location.href = 'login.html';
                return;
            }

            const groupData = {
                name: name,
                description: description,
                members: currentGroupMembers,
                commitments: currentGroupCommitments
            };

            try {
                showLoading(true);

                let response;

                if (editingGroup) {
                    response = await API.WorkGroups.update(editingGroup.id, groupData);
                } else {
                    response = await API.WorkGroups.create(groupData);
                }

                if (response.success) {
                    showSuccess(`Equipo ${editingGroup ? 'actualizado' : 'creado'} exitosamente`);
                    await initializeData();
                    renderGroups();
                    bootstrap.Modal.getInstance(document.getElementById('groupModal')).hide();
                } else {
                    showError(`Error: ` + response.error);
                }
            } catch (error) {
                console.error('Error saving group:', error);
                showError('Error al guardar: ' + error.message);
            } finally {
                showLoading(false);
            }
        }

        // Delete group
        function deleteGroup(id) {
            const group = groups.find(g => g.id === id);
            if (group) {
                document.getElementById('deleteModalMessage').textContent = `¿Eliminar "${group.name}"?`;
                const modal = new bootstrap.Modal(document.getElementById('deleteModal'));
                modal.show();

                const confirmBtn = document.getElementById('confirmDeleteBtn');
                const handleConfirm = async function () {
                    try {
                        showLoading(true);
                        const response = await API.WorkGroups.delete(id);

                        if (response.success) {
                            showSuccess('Equipo eliminado');
                            await initializeData();
                            renderGroups();
                            modal.hide();
                        } else {
                            showError('Error: ' + response.error);
                        }
                    } catch (error) {
                        console.error('Error deleting group:', error);
                        showError('Error: ' + error.message);
                    } finally {
                        showLoading(false);
                    }
                };
                confirmBtn.addEventListener('click', handleConfirm, { once: true });
            }
        }

        // View group details
        function viewGroupDetails(id) {
            const group = groups.find(g => g.id === id);
            if (!group) return;

            let detailsHTML = `
                <div class="container-fluid">
                    <h4 class="text-primary mb-3"><i class="bi bi-people-fill"></i> ${group.name}</h4>
                    <p class="text-muted">${group.description || 'Sin descripción'}</p>
                    <div class="row">
                        <div class="col-md-6">
                            <h5><i class="bi bi-person-badge"></i> Miembros</h5>
                            <div class="list-group">`;

            if (group.members && group.members.length > 0) {
                group.members.forEach(username => {
                    detailsHTML += `<div class="list-group-item"><i class="bi bi-person-circle"></i> ${username}</div>`;
                });
            } else {
                detailsHTML += '<div class="list-group-item text-muted">Sin miembros</div>';
            }

            detailsHTML += `
                            </div>
                        </div>
                        <div class="col-md-6">
                            <h5><i class="bi bi-clipboard-check"></i> Compromisos</h5>
                            <div class="list-group">`;

            if (group.commitments && group.commitments.length > 0) {
                group.commitments.forEach(commitmentId => {
                    const commitment = commitments.find(c => c.id === commitmentId);
                    const name = commitment ? commitment.name : `#${commitmentId}`;
                    detailsHTML += `<div class="list-group-item"><i class="bi bi-check-circle"></i> ${name}</div>`;
                });
            } else {
                detailsHTML += '<div class="list-group-item text-muted">Sin compromisos</div>';
            }

            detailsHTML += `</div></div></div></div>`;

            document.getElementById('detailsModalBody').innerHTML = detailsHTML;
            new bootstrap.Modal(document.getElementById('detailsModal')).show();
        }

        // Event listeners
        document.addEventListener('DOMContentLoaded', async function () {
            checkAccess();
            await initializeData();
            renderGroups();

            document.getElementById('searchInput').addEventListener('input', function() {
                clearTimeout(this.timeout);
                this.timeout = setTimeout(() => filterGroups(), 300);
            });
        });
    </script>
</body>

</html>
